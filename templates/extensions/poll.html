{% extends "base.html" %}

{% block meta %}
  {% set_global langage = add_endpoint_path | split(pat="/") | last %}

  {% if langage == "fr" %}
    {% set_global poll = poll_fr %}
  {% elif langage == "en" %}
    {% set_global poll = poll_en %}
  {% else %}
    {{ throw(message="Langage not set: " ~ add_endpoint_path) }}
  {% endif %}

  <meta name=" robots" content=" index">
  <meta property="og:type" content="profile" />
  <meta property="og:title" content="{{ poll.title }}" />
  {% if site.og_image %}
  <meta property="og:image" content="{{site.base_url | safe}}/{{ site.og_image }}" />
  {% endif %}
  <meta property="og:url" content="{{ site.base_url | safe }}/{{ add_endpoint_path }}" />
  <meta property="og:site_name" content="{{ site.name }}" />
{% endblock meta %}

{% block stylesheets %}
  <link rel="stylesheet" href="/poll.css" />
{% endblock stylesheets %}

{% block scripts %}
  <script type="text/javascript" src="/poll.js"></script>
  <script>
  {% for qsetslug, qset in poll.question %}
    // TODO  Make this script, call a pre-made function in poll.js to register events
    {% for qslug, q in qset %}
      {% if q.type == "yes_or_no" %}
        {% if q.addq_yes %}
          console.log("Add event listener for {{ qslug }}, display questions {{ q.addq_yes }} if yes");
        {% endif %}
        {% if q.addq_no %}
          console.log("Add event listener for {{ qslug }}, display questions {{ q.addq_no }} if no");
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endfor %}
  // Then make the first question display-able
  </script>
{% endblock scripts %}

{% block title %}{{ poll.title }}{% endblock title %}

{% macro disp_child_question(parents, key, poll) %}
  {% set new_parents = parents | concat(with=[key]) %}
  {% for qslug, q in poll.question[key] %}
    {{ self::disp_question(qslug=qslug, q=q, poll=poll, parents=new_parents) }}
  {% endfor %}
{% endmacro disp_child_question %}

{% macro disp_question(qslug, q, poll, parents) %}
  {% if parents | length == 0 %}
    {% set addclass = "" %}
    {% set idbase = qslug %}
  {% else %}
    {% set addclass = parents | join(sep="_") %}
    {% set idbase = addclass ~ "-" ~ qslug %}
  {% endif %}

  <li id="q-{{idbase}}" class="question-container {{ addclass }}">
    <p class="question-text">{{ q.text }}</p>
    {% if q.note %}
      <p class="question-note">{{ q.note }}</p>
    {% endif %}
    {% if q.label %}
      <label for="{{idbase}}">{{ q.label }}</label>
    {% endif %}

    {% if q.type == "yes_or_no" %}
      <input type="radio" id="{{ idbase }}-yes" name="{{ idbase }}" value="true">
      <label for="{{ idbase }}-yes">{{ poll.lang.yes }}</label>
      <input type="radio" id="{{ idbase }}-no"  name="{{ idbase }}" value="false">
      <label for="{{ idbase }}-no">{{ poll.lang.no }}</label>
    {% endif %}

    {% if q.type == "radio" %}
      {% for choice in q.choices %}
      <input type="radio" id="{{ idbase }}-{{ choice | slugify }}" name="{{ idbase }}" value="{{ loop.index0 }}">
      <label for="{{ idbase }}-{{ choice | slugify }}">{{ choice }}</label>
      <br/>
      {% endfor %}
    {% endif %}

    {% if q.type == "number" %}
      <input type="number" id="{{ idbase }}" name="{{ idbase }}" min="{{ q.min }}" max="{{ q.max }}">
    {% endif %}

    {% if q.type == "range" %}
      <input type="range" id="{{ idbase }}" name="{{ idbase }}" min="{{ q.min}}" max="{{ q.max}}" value="{{ q.min + ((q.max - q.min) / 2) }}" list="rangelist-{{ qslug }}">
      {% if q.display_value %}
        <output id="{{ idbase }}-value" class="range-value"></output>
      {% endif %}
    {% endif %}

    {% if q.type == "text" %}
      <input type="text" id="{{ idbase }}" name="{{ idbase }}" size="100%">
    {% endif %}
  </li>

  {% if q.addq_yes %}
    {{ self::disp_child_question(parents=parents, key=q.addq_yes, poll=poll) }}
  {% endif %}
  {% if q.addq_no %}
    {{ self::disp_child_question(parents=parents, key=q.addq_no, poll=poll) }}
  {% endif %}
{% endmacro disp_question %}

{% block content %}
  <div id="poll-disclamer">
    {{ poll.disclamer }}
  </div>

  <form id="poll-form">
  <ul>
  {% for qslug, q in poll.question[poll.first_question_set] %}
    {{ self::disp_question(qslug=qslug, q=q, poll=poll, parents=[]) }}
  {% endfor %}
  </ul>

  <input type="text" id="save-data-token" name="save-data-token" style="display: none;"/>

  <!--
    TODO  Submit button to a save-data endpoint in ecoweb -> new extension
          Add a password entry before submit to prevent spoofing
          Encrypt the data using asymetric encryption
  -->
  <input type="submit" id="submitForm" value="{{ poll.lang.send_button }}" formaction="/savedata/business_survey_{{ langage }}" formmethod="post"/>
  </form>
{% endblock content %}
